<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ€KPå°ç£æ°‘çœ¾é»¨ é»¨å“¡æŸ¥è©¢ç³»çµ±ğŸ€</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
      background: #70cce1;
    }
    h1 {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
    }
    h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin-top: 4px;
      font-size: 14px;
    }
    button {
      margin-top: 10px;
      margin-right: 6px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      /* é‚Šæ¡†é¡è‰²æ”¹æˆè·ŸèƒŒæ™¯ä¸€æ¨£ */
      border: 2px solid #2091c6;
      background: #70cce1;
      color: white;
    }
    button:active {
      transform: scale(0.97);
    }
    .item {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    /* éŠæˆ²åå­—ï¼šæ”¾ä¸Šé¢ & å¤§ä¸€é» */
    .item-main {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 2px;
      word-break: break-all;
    }
    /* LINE IDï¼šæ”¾ç¬¬äºŒè¡Œ */
    .item-sub {
      font-size: 14px;
      margin-bottom: 2px;
      word-break: break-all;
    }
    .item-time {
      font-size: 12px;
      color: #666;
    }
    .empty-text {
      color: #888;
      font-size: 14px;
    }
    small {
      color: #777;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>KPå°ç£æ°‘çœ¾é»¨ é»¨å“¡æŸ¥è©¢ç³»çµ±</h1>

  <!-- æ–°å¢ / æŸ¥è©¢ -->
  <div class="section">
    <h2>æ–°å¢ / æŸ¥è©¢</h2>
    <label>
      LINE IDï¼š
      <input id="lineInput" type="text" placeholder="line_id" />
    </label>
    <label>
      éŠæˆ²åå­—ï¼š
      <input id="gameInput" type="text" placeholder="ä¾‹ï¼šá´·á´¾áƒ¦å¸¥å¸¥å“¥" />
    </label>
    <div>
      <button onclick="saveRecord()">å„²å­˜</button>
      <button onclick="searchRecords()">æŸ¥è©¢</button>
      <button onclick="loadAll()">é¡¯ç¤ºå…¨éƒ¨</button>
    </div>
    <small>â— å„²å­˜ï¼šæœƒæ–°å¢ä¸€ç­†æ–°çš„è³‡æ–™ã€‚<br>
           â— æŸ¥è©¢ï¼šåªé¡¯ç¤ºç¬¦åˆç›®å‰è¼¸å…¥å…§å®¹çš„è³‡æ–™ï¼ˆå¯åªå¡«ä¸€æ ¼ï¼‰ã€‚</small>
  </div>

  <!-- æ›´æ”¹è³‡æ–™ -->
  <div class="section">
    <h2>æ›´æ”¹è³‡æ–™</h2>

    <!-- æ›´æ”¹ LINE ID -->
    <label>
      èˆŠ LINE IDï¼š
      <input id="oldLineInput" type="text" placeholder="èˆŠ LINE ID" />
    </label>
    <label>
      æ–° LINE IDï¼š
      <input id="newLineInput" type="text" placeholder="æ–° LINE ID" />
    </label>
    <button onclick="updateLineId()">æ›´æ”¹ LINE ID</button>

    <hr style="margin:12px 0; border:none; border-top:1px solid #ddd;">

    <!-- æ›´æ”¹ éŠæˆ²åå­— -->
    <label>
      èˆŠéŠæˆ²åå­—ï¼š
      <input id="oldGameInput" type="text" placeholder="èˆŠéŠæˆ²åå­—" />
    </label>
    <label>
      æ–°éŠæˆ²åå­—ï¼š
      <input id="newGameInput" type="text" placeholder="æ–°éŠæˆ²åå­—" />
    </label>
    <button onclick="updateGameName()">æ›´æ”¹éŠæˆ²åå­—</button>

    <small>
      â— æ›´æ”¹æ˜¯ã€Œå…¨éƒ¨ç¬¦åˆçš„éƒ½ä¸€èµ·æ”¹ã€ï¼Œä¾‹å¦‚æœ‰å¤šç­†ä¸€æ¨£çš„èˆŠåå­—ï¼Œæœƒå…¨éƒ¨æ›´æ–°ã€‚<br>
    </small>
  </div>

  <!-- é¡¯ç¤ºçµæœ -->
  <div class="section">
    <h2 id="listTitle">ç›®å‰è³‡æ–™</h2>
    <div id="listContainer"></div>
  </div>

  <!-- Firebase æ¨¡çµ„ + Firestoreï¼ˆç„¡åˆªé™¤ç‰ˆï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyAtaboHWv60PRfwY5qwhOeECq-U_2mDi5M",
      authDomain: "linename-76527.firebaseapp.com",
      projectId: "linename-76527",
      storageBucket: "linename-76527.firebasestorage.app",
      messagingSenderId: "403725086740",
      appId: "1:403725086740:web:6b8b09e8b2e64008fab701"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "line_game_records");

    // é˜²æƒ¡æ„è¼¸å…¥
    function cleanInput(str, fieldName, maxLen = 30) {
      const s = (str || "").trim();

      if (!s) {
        throw new Error(fieldName + " ä¸èƒ½æ˜¯ç©ºç™½");
      }
      if (s.length > maxLen) {
        throw new Error(fieldName + " å¤ªé•·äº†ï¼Œæœ€å¤š " + maxLen + " å€‹å­—");
      }
      if (/[<>]/.test(s)) {
        throw new Error(fieldName + " ä¸èƒ½åŒ…å« < æˆ– > é€™é¡ç¬¦è™Ÿ");
      }
      return s;
    }

    // æ™‚é–“æ ¼å¼
    function formatTime(timestamp) {
      const d = new Date(timestamp);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }

    // é¡¯ç¤ºåˆ—è¡¨ï¼šéŠæˆ²ååœ¨ä¸Šã€LINE ID åœ¨ä¸‹
    function renderList(list, titleText) {
      const container = document.getElementById('listContainer');
      const title = document.getElementById('listTitle');

      title.textContent = titleText || 'ç›®å‰è³‡æ–™';
      container.innerHTML = '';

      if (!list || list.length === 0) {
        container.innerHTML = '<div class="empty-text">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚</div>';
        return;
      }

      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';

        const mainDiv = document.createElement('div');
        mainDiv.className = 'item-main';
        mainDiv.textContent = 'éŠæˆ²åå­—ï¼š' + item.gameName;

        const subDiv = document.createElement('div');
        subDiv.className = 'item-sub';
        subDiv.textContent = 'LINE IDï¼š' + item.lineId;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'item-time';
        timeDiv.textContent = 'å»ºç«‹æ™‚é–“ï¼š' + formatTime(item.createdAt);

        div.appendChild(mainDiv);
        div.appendChild(subDiv);
        div.appendChild(timeDiv);

        container.appendChild(div);
      });
    }

    // è®€å–å…¨éƒ¨
    async function loadAll() {
      try {
        const snap = await getDocs(colRef);
        const list = [];
        snap.forEach(d => {
          const data = d.data();
          list.push({
            id: d.id,
            lineId: data.lineId || "",
            gameName: data.gameName || "",
            createdAt: data.createdAt || 0
          });
        });

        list.sort((a, b) => b.createdAt - a.createdAt);
        renderList(list, "å…¨éƒ¨è³‡æ–™ï¼ˆæœ€æ–°åœ¨ä¸Šé¢ï¼‰");
      } catch (e) {
        console.error(e);
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    // å„²å­˜ï¼ˆé™åˆ¶é•·åº¦ 14ï¼‰
    async function saveRecord() {
      const lineInput = document.getElementById('lineInput');
      const gameInput = document.getElementById('gameInput');

      try {
        const lineId = cleanInput(lineInput.value, "LINE ID", 14);
        const gameName = cleanInput(gameInput.value, "éŠæˆ²åå­—", 14);

        await addDoc(colRef, {
          lineId,
          gameName,
          createdAt: Date.now()
        });

        lineInput.value = "";
        gameInput.value = "";
        await loadAll();
      } catch (e) {
        alert(e.message || "å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        console.error(e);
      }
    }

    // æŸ¥è©¢
    async function searchRecords() {
      const rawLine = document.getElementById('lineInput').value;
      const rawGame = document.getElementById('gameInput').value;

      const line = rawLine.trim();
      const game = rawGame.trim();

      if (!line && !game) {
        alert('è‹¥è¦æŸ¥è©¢ï¼Œè«‹è‡³å°‘è¼¸å…¥ LINE ID æˆ–éŠæˆ²åå­—å…¶ä¸­ä¸€å€‹ã€‚');
        return;
      }

      try {
        let qRef;

        if (line && game) {
          qRef = query(colRef,
            where("lineId", "==", line),
            where("gameName", "==", game)
          );
        } else if (line) {
          qRef = query(colRef, where("lineId", "==", line));
        } else {
          qRef = query(colRef, where("gameName", "==", game));
        }

        const snap = await getDocs(qRef);
        const list = [];
        snap.forEach(d => {
          const data = d.data();
          list.push({
            id: d.id,
            lineId: data.lineId || "",
            gameName: data.gameName || "",
            createdAt: data.createdAt || 0
          });
        });

        list.sort((a, b) => b.createdAt - a.createdAt);
        renderList(list, "æŸ¥è©¢çµæœ");

        if (list.length === 0) {
          alert("æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚");
        }
      } catch (e) {
        console.error(e);
        alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    // æ›´æ”¹ LINE ID
    async function updateLineId() {
      const oldLineRaw = document.getElementById('oldLineInput').value;
      const newLineRaw = document.getElementById('newLineInput').value;

      try {
        const oldLine = cleanInput(oldLineRaw, "èˆŠ LINE ID", 30);
        const newLine = cleanInput(newLineRaw, "æ–° LINE ID", 30);

        const qRef = query(colRef, where("lineId", "==", oldLine));
        const snap = await getDocs(qRef);

        if (snap.empty) {
          alert("æ‰¾ä¸åˆ°ç¬¦åˆã€ŒèˆŠ LINE IDã€çš„è³‡æ–™ã€‚");
          return;
        }

        let count = 0;
        const promises = [];
        snap.forEach(d => {
          promises.push(updateDoc(d.ref, { lineId: newLine }));
          count++;
        });

        await Promise.all(promises);
        alert(`å·²æ›´æ”¹ LINE IDï¼Œå…± ${count} ç­†ã€‚`);

        document.getElementById('oldLineInput').value = '';
        document.getElementById('newLineInput').value = '';

        await loadAll();
      } catch (e) {
        alert(e.message || "æ›´æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        console.error(e);
      }
    }

    // æ›´æ”¹éŠæˆ²åå­—
    async function updateGameName() {
      const oldGameRaw = document.getElementById('oldGameInput').value;
      const newGameRaw = document.getElementById('newGameInput').value;

      try {
        const oldGame = cleanInput(oldGameRaw, "èˆŠéŠæˆ²åå­—", 30);
        const newGame = cleanInput(newGameRaw, "æ–°éŠæˆ²åå­—", 30);

        const qRef = query(colRef, where("gameName", "==", oldGame));
        const snap = await getDocs(qRef);

        if (snap.empty) {
          alert("æ‰¾ä¸åˆ°ç¬¦åˆã€ŒèˆŠéŠæˆ²åå­—ã€çš„è³‡æ–™ã€‚");
          return;
        }

        let count = 0;
        const promises = [];
        snap.forEach(d => {
          promises.push(updateDoc(d.ref, { gameName: newGame }));
          count++;
        });

        await Promise.all(promises);
        alert(`å·²æ›´æ”¹éŠæˆ²åå­—ï¼Œå…± ${count} ç­†ã€‚`);

        document.getElementById('oldGameInput').value = '';
        document.getElementById('newGameInput').value = '';

        await loadAll();
      } catch (e) {
        alert(e.message || "æ›´æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        console.error(e);
      }
    }

    // å°‡å‡½å¼æ›åˆ° window
    window.loadAll = loadAll;
    window.saveRecord = saveRecord;
    window.searchRecords = searchRecords;
    window.updateLineId = updateLineId;
    window.updateGameName = updateGameName;

    // ä¸€é–‹å§‹è¼‰å…¥å…¨éƒ¨è³‡æ–™
    window.addEventListener("load", loadAll);
  </script>
</body>
</html>
