<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPå°ç£æ°‘çœ¾é»¨ é»¨å“¡æŸ¥è©¢ç³»çµ±</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
      background: #70cce1;
    }

    h1 {
      font-size: 27px;
      font-weight: bold;
      margin-bottom: 16px;
      text-align: center;
    }

    h2 {
      font-size: 17px;
      font-weight: bold;
      margin: 0;
      padding: 0;
    }

    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.05);
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      margin-top: 10px;
      margin-right: 6px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      border: 3px solid #2091c6;
      background: #70cce1;
      color: black;
    }

    button:active {
      background: #2276bd;
      transform: scale(0.97);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* æŠ˜ç–Šå€å¡Šå‹•ç•«ï¼šæ–°å¢/æŸ¥è©¢ */
    .collapse-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
      margin-top: 10px;
    }

    .collapse-content.open {
      max-height: 500px;
    }

    /* æ›´æ”¹è³‡æ–™æŠ˜ç–Š */
    #editPanel {
      max-height: 0;
      overflow: hidden;
      margin-top: 10px;
      transition: max-height 0.5s ease;
    }

    #editPanel.open {
      max-height: 600px;
    }

    #toggleEdit, #toggleAdd {
      margin-left: 10px;
    }

    .item {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }

    .item-main {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .item-sub {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .item-time {
      font-size: 12px;
      color: #666;
    }

    .empty-text {
      font-size: 14px;
      color: #888;
    }
  </style>
</head>

<body>

  <h1>KPå°ç£æ°‘çœ¾é»¨ é»¨å“¡æŸ¥è©¢ç³»çµ±</h1>

<!-- æ–°å¢ / æŸ¥è©¢ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
<div class="section">
  <div class="top-bar" style="display:flex; align-items:center; justify-content:flex-start; gap:10px;">
    <h2 style="margin-right:10px;">æ–°å¢ / æŸ¥è©¢</h2>

    <!-- å±•é–‹æŒ‰éˆ•ï¼šå­—è®Šå¤§ -->
    <button id="toggleAdd">â–¼ å±•é–‹</button>

    <!-- é¡¯ç¤ºå…¨éƒ¨ æ”¾åœ¨æ—é‚Š -->
    <button onclick="loadAll()">é¡¯ç¤ºå…¨éƒ¨</button>
  </div>
  <small>
  â— é¡¯ç¤ºå…¨éƒ¨:ç›´æ¥é¡¯ç¤ºæ‰€æœ‰åå–®
  </small>


  <div id="addPanel" class="collapse-content">
    <label>
      LINE IDï¼š
      <input id="lineInput" type="text" placeholder="ä¾‹ï¼šjasonğŸ˜ˆğŸºğŸ› ğŸ˜º" />
    </label>

    <label>
      éŠæˆ²åå­—ï¼š
      <input id="gameInput" type="text" placeholder="ä¾‹ï¼šá´·á´¾áƒ¦å¸¥å¸¥å“¥" />
    </label>

    <button onclick="saveRecord()">å„²å­˜</button>
    <button onclick="searchRecords()">æŸ¥è©¢</button>
    <button onclick="clearInputs()">æ¸…é™¤</button>

    <small><br>
      â— å„²å­˜ï¼šæ–°å¢ä¸€ç­†æ–°è³‡æ–™<br>
      â— æŸ¥è©¢ï¼šå¯è¼¸å…¥éƒ¨åˆ†æ–‡å­—åšæ¨¡ç³Šæœå°‹<br>
      â— æ¸…é™¤ï¼šå°‡è¼¸å…¥æ¡†å…§çš„æ–‡å­—åˆªé™¤
    </small>
  </div>
</div>


  <!-- æ›´æ”¹è³‡æ–™ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
  <div class="section">
    <h2 style="display:flex; align-items:center;">
      <span style="margin-top:7px;">æ›´æ”¹è³‡æ–™</span>
      <button id="toggleEdit">â–¼ å±•é–‹</button>
    </h2>

    <div id="editPanel">
      <!-- æ›´æ”¹ LINE ID -->
      <label>èˆŠ LINE IDï¼š
        <input id="oldLineInput" type="text" placeholder="èˆŠ LINE ID">
      </label>

      <label>æ–° LINE IDï¼š
        <input id="newLineInput" type="text" placeholder="æ–° LINE ID">
      </label>

      <button onclick="updateLineId()">æ›´æ”¹ LINE ID</button>

      <hr>

      <!-- æ›´æ”¹ éŠæˆ²åå­— -->
      <label>èˆŠéŠæˆ²åå­—ï¼š
        <input id="oldGameInput" type="text" placeholder="èˆŠéŠæˆ²åå­—">
      </label>

      <label>æ–°éŠæˆ²åå­—ï¼š
        <input id="newGameInput" type="text" placeholder="æ–°éŠæˆ²åå­—">
      </label>

      <button onclick="updateGameName()">æ›´æ”¹éŠæˆ²åå­—</button>

      <small><br>
        â— è‹¥æœ‰å¤šç­†ç›¸åŒèˆŠåç¨±ï¼Œæœƒå…¨éƒ¨ä¸€èµ·ä¿®æ”¹
      </small>
    </div>
  </div>

  <!-- é¡¯ç¤ºçµæœ -->
  <div class="section">
    <h2 id="listTitle">ç›®å‰è³‡æ–™(ç„¡)</h2>
    <div id="listContainer"></div>
  </div>


  <!-- Firebase + Firestore -->
  <script type="module">
    window.clearInputs = function () {
      document.getElementById("lineInput").value = "";
      document.getElementById("gameInput").value = "";

      showAlert("å·²æ¸…é™¤è¼¸å…¥å…§å®¹ï¼");
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc,
      getDocs, query, where, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtaboHWv60PRfwY5qwhOeECq-U_2mDi5M",
      authDomain: "linename-76527.firebaseapp.com",
      projectId: "linename-76527",
      storageBucket: "linename-76527.firebasestorage.app",
      messagingSenderId: "403725086740",
      appId: "1:403725086740:web:6b8b09e8b2e64008fab701"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "line_game_records");


    /* -------------------- å·¥å…· -------------------- */
    function cleanInput(str, fieldName, maxLen = 14) {
      const s = (str || "").trim();
      if (!s) throw new Error(fieldName + " ä¸èƒ½ç©ºç™½");
      if (s.length > maxLen) throw new Error(fieldName + " æœ€å¤š " + maxLen + " å€‹å­—");
      if (/[<>]/.test(s)) throw new Error(fieldName + " ä¸èƒ½åŒ…å« < >");
      return s;
    }

    function formatTime(ts) {
      if (!ts) return "æœªç´€éŒ„";
      const d = new Date(ts);
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}
              ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function renderList(list, titleText) {
      const box = document.getElementById("listContainer");
      document.getElementById("listTitle").textContent = titleText;
      box.innerHTML = "";

      if (!list.length) {
        box.innerHTML = `<div class="empty-text">æ²’æœ‰è³‡æ–™ã€‚</div>`;
        return;
      }

      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";

        div.innerHTML = `
          <div class="item-main">éŠæˆ²åå­—ï¼š${item.gameName}</div>
          <div class="item-sub">LINE IDï¼š${item.lineId}</div>
          <div class="item-time">ä¿®æ”¹æ™‚é–“ï¼š${formatTime(item.updatedAt)}</div>
        `;
        box.appendChild(div);
      });
    }


    /* -------------------- æŠ˜ç–Šæ§åˆ¶ -------------------- */
    window.addEventListener("load", () => {
      const addBtn = document.getElementById("toggleAdd");
      const addPanel = document.getElementById("addPanel");

      addBtn.addEventListener("click", () => {
        const open = addPanel.classList.toggle("open");
        addBtn.textContent = open ? "â–² æ”¶åˆ" : "â–¼ å±•é–‹";
      });

      const editBtn = document.getElementById("toggleEdit");
      const editPanel = document.getElementById("editPanel");

      editBtn.addEventListener("click", () => {
        const open = editPanel.classList.toggle("open");
        editBtn.textContent = open ? "â–² æ”¶åˆ" : "â–¼ å±•é–‹";
      });
    });


    /* -------------------- Firestore åŠŸèƒ½ -------------------- */

    async function loadAll() {
      const snap = await getDocs(colRef);
      const list = [];

      snap.forEach(doc => {
        const d = doc.data();
        list.push({
          id: doc.id,
          lineId: d.lineId,
          gameName: d.gameName,
          updatedAt: d.updatedAt || d.createdAt
        });
      });

      list.sort((a, b) => b.updatedAt - a.updatedAt);
      renderList(list, "å…¨éƒ¨è³‡æ–™ï¼ˆä¾ä¿®æ”¹æ™‚é–“ï¼‰");
    }


    async function saveRecord() {
      try {
        const line = cleanInput(document.getElementById("lineInput").value, "LINE ID");
        const game = cleanInput(document.getElementById("gameInput").value, "éŠæˆ²åå­—");
        const now = Date.now();

        await addDoc(colRef, {
          lineId: line,
          gameName: game,
          createdAt: now,
          updatedAt: now
        });

        document.getElementById("lineInput").value = "";
        document.getElementById("gameInput").value = "";
        loadAll();

      } catch (e) {
        alert(e.message);
      }
    }


    async function searchRecords() {
      const line = document.getElementById("lineInput").value.trim().toLowerCase();
      const game = document.getElementById("gameInput").value.trim().toLowerCase();

      if (!line && !game) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€é …æŸ¥è©¢");

      const snap = await getDocs(colRef);
      const list = [];

      snap.forEach(doc => {
        const d = doc.data();
        const lineId = d.lineId.toLowerCase();
        const gameName = d.gameName.toLowerCase();
        const time = d.updatedAt || d.createdAt;

        if (line && !lineId.includes(line)) return;
        if (game && !gameName.includes(game)) return;

        list.push({
          id: doc.id,
          lineId: d.lineId,
          gameName: d.gameName,
          updatedAt: time
        });
      });

      list.sort((a, b) => b.updatedAt - a.updatedAt);
      renderList(list, "æœå°‹çµæœ");
    }


    async function updateLineId() {
      try {
        const oldLine = cleanInput(document.getElementById("oldLineInput").value, "èˆŠ LINE ID", 30);
        const newLine = cleanInput(document.getElementById("newLineInput").value, "æ–° LINE ID", 30);

        const q = query(colRef, where("lineId", "==", oldLine));
        const snap = await getDocs(q);
        if (snap.empty) return alert("æ‰¾ä¸åˆ°è©² LINE ID");

        const now = Date.now();
        snap.forEach(doc => updateDoc(doc.ref, { lineId: newLine, updatedAt: now }));

        alert("ä¿®æ”¹æˆåŠŸï¼");
        loadAll();

      } catch (e) {
        alert(e.message);
      }
    }


    async function updateGameName() {
      try {
        const oldGame = cleanInput(document.getElementById("oldGameInput").value, "èˆŠéŠæˆ²åå­—", 30);
        const newGame = cleanInput(document.getElementById("newGameInput").value, "æ–°éŠæˆ²åå­—", 30);

        const q = query(colRef, where("gameName", "==", oldGame));
        const snap = await getDocs(q);
        if (snap.empty) return alert("æ‰¾ä¸åˆ°è©²éŠæˆ²åå­—");

        const now = Date.now();
        snap.forEach(doc => updateDoc(doc.ref, { gameName: newGame, updatedAt: now }));

        alert("ä¿®æ”¹å®Œæˆï¼");
        loadAll();

      } catch (e) {
        alert(e.message);
      }
    }


    window.saveRecord = saveRecord;
    window.searchRecords = searchRecords;
    window.updateLineId = updateLineId;
    window.updateGameName = updateGameName;
    window.loadAll = loadAll;

  </script>

</body>
</html>
